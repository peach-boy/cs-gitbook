## 分布式系统之幂等性

### 什么是幂等性

同一个请求重试多次，返回的结果是相同的。

### 为什么要保证幂等性

在分布式系统中，系统间的调用都是基于接口调用，我们常用的http请求是无状态，当调用方因为某些原因没有得到调用结果,通常我们的做法会重试，那么我们在设计系统的时候就需要保证，多次调用产生的结果。

### 如何判断接口是否需要保证幂等性

判断依据在于，多次请求是否会改变数据（DB或cache）。

### 如何保证幂等性

- 查询接口：查询接口本身就是幂等的，无需处理。

- 创建接口：创建接口需要保证幂等性
  - 注册会员场景
  - 电商下单场景
- 更新接口：更新绝对值幂等，更新相对值不幂等
  - 更新状态
  - 更新金额
- 删除接口：删除绝对值幂等，删除相对值不幂等

### 常见场景

- mq消费接口重复消费场景

  当消费者消费失败，消息会重新入队，消费者会再次消费同样的数据。例如：支付系统完成一笔支付后，会向各系统广播一条消息，营销系统收到后，会先落库，然后根据配置的营销活动判断该订单是否触发优惠券发放。如果消费端出现异常，消息就会出现重复消费，就有可能造成优惠券的重复发放，这是不允许。所以简单的做法，在消费时先查询是否已发放，发放成功则返回成功

- 定时任务接口

  当任务执行异常时没有更新执行标识（如，status），但是实际逻辑已经执行完成，下一时刻会继续执行，所以在执行任务前，需判断该任务是否已经执行过。

- 订单支付防止重复支付场景

  在支付场景中，通常的流程都是先下单，第一步会在订单系统中落订单（当然此处省略前置的各种库存校验，冻结库存），第二步请求支付系统完成资产扣减，那么问题来了，当在第二步过程中出现网络抖动，订单系统没有没有收到响应，此时用户看到的订单状态还是未支付，用户大概率会发起第二次操作，此时，在支付系统中该订单已经支付成功。如果在支付端不做任何处理，那将会出现严重的订单重复支付问题。
  所以在支付接口必须保证幂等性。当请求再次到达时，先查询支付系统的支付单中是否有该订单的支付记录，如果有则返回。

